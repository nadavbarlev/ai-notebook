{% extends "base.html" %}
{% block title %}RAG Chatbot{% endblock %}

{% block content %}
<section class="grid">
  <!-- Left: Robot + Chat -->
  <div class="col chat-col card">
    <div class="robot-stage">
      <div id="robot" class="robot">
        <div class="antenna"><span class="tip"></span></div>
        <div class="head">
          <div class="eyes">
            <span class="eye left"><i></i></span>
            <span class="eye right"><i></i></span>
          </div>
          <div class="mouth"></div>
        </div>
        <div class="body"><div class="panel"></div></div>
      </div>
    </div>

    <div id="messages" class="messages" aria-live="polite"></div>

    <form id="chat-form" class="chat-form" autocomplete="off">
      <input id="chat-input" type="text" placeholder="Ask me anything from your docs…" required />
      <div class="controls">
        <label class="k-label">
          Top-K
          <input id="topk" type="number" min="1" max="10" value="4">
        </label>
        <button id="send-btn" type="submit">Send</button>
      </div>
    </form>
  </div>

  <!-- Right: Docs panel -->
  <div class="col docs-col">
    <section class="card">
      <h2>Documents</h2>
      <p class="muted">Upload <code>.txt</code> files. The index is rebuilt automatically.</p>
      <form id="upload-form" enctype="multipart/form-data" class="upload-form">
        <input type="file" name="files" id="files" accept=".txt" multiple>
        <button type="submit" class="secondary">Upload & Reindex</button>
        <button type="button" id="reindex-btn" class="ghost">Reindex</button>
      </form>
      <div id="status" class="muted small">Loading status…</div>
    </section>

    <section class="card">
      <h2>Last Context</h2>
      <details id="ctx-details" open>
        <summary>Show/Hide</summary>
        <ol id="context-list"></ol>
      </details>
    </section>
  </div>
</section>

<script>
const msgs  = document.getElementById("messages");
const robot = document.getElementById("robot");
const input = document.getElementById("chat-input");
const form  = document.getElementById("chat-form");
const sendBtn = document.getElementById("send-btn");
const topKEl  = document.getElementById("topk");
const ctxList = document.getElementById("context-list");
const statusEl = document.getElementById("status");

// Bubble helpers
function addBubble(text, who="user") {
  const wrap = document.createElement("div");
  wrap.className = `bubble ${who}`;
  wrap.textContent = text;
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
  return wrap;
}
async function typeInto(el, text, delay=12) {
  el.textContent = "";
  for (let i = 0; i < text.length; i++) {
    el.textContent += text[i];
    await new Promise(r => setTimeout(r, delay));
    msgs.scrollTop = msgs.scrollHeight;
  }
}
function setThinking(on) {
  robot.classList.toggle("thinking", on);
  sendBtn.disabled = on;
}

// Health/status
async function refreshHealth() {
  try {
    const res = await fetch("/health");
    const data = await res.json();
    statusEl.textContent = `Indexed docs: ${data.docs}  |  Ready: ${data.indexed ? "yes" : "no"}`;
  } catch {
    statusEl.textContent = "Status unavailable.";
  }
}

// Upload/reindex
document.getElementById("upload-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  const res = await fetch("/upload", { method: "POST", body: fd });
  const data = await res.json();
  statusEl.textContent = data.error ? `Error: ${data.error}`
                                    : `Saved: ${data.saved?.join(", ") || "none"} | Indexed docs: ${data.docs_indexed}`;
});

document.getElementById("reindex-btn").addEventListener("click", async () => {
  const res = await fetch("/reindex", { method: "POST" });
  const data = await res.json();
  statusEl.textContent = data.error ? `Error: ${data.error}`
                                    : `Reindexed. Indexed docs: ${data.docs_indexed}`;
});

// Chat
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const question = input.value.trim();
  if (!question) return;
  const k = Math.max(1, Math.min(10, parseInt(topKEl.value || "4", 10)));

  // user bubble
  addBubble(question, "user");
  input.value = "";

  // bot bubble placeholder
  const botBubble = addBubble("…", "bot");
  setThinking(true);

  try {
    const res = await fetch("/ask", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ question, k })
    });
    const data = await res.json();

    // context on the side panel
    ctxList.innerHTML = "";
    (data.context || []).forEach(c => {
      const li = document.createElement("li");
      li.textContent = c;
      ctxList.appendChild(li);
    });

    if (data.error) {
      await typeInto(botBubble, "⚠️ " + data.error, 10);
    } else {
      await typeInto(botBubble, data.answer || "(no answer)", 8);
    }
  } catch (err) {
    await typeInto(botBubble, "⚠️ Could not reach the server.", 12);
  } finally {
    setThinking(false);
    refreshHealth();
  }
});

// init
refreshHealth();
</script>
{% endblock %}